name: Build with New API

env:
  YARN_INSTALL_NOPT: yarn add --ignore-platform --ignore-optional

on:
  push:
    branches:
      - NewApi  # ç›‘å¬ NewApi åˆ†æ”¯çš„æ¨é€
    tags:
      - v*-newapi  # ç›‘å¬å¸¦ newapi æ ‡ç­¾çš„ç‰ˆæœ¬
  pull_request:
    branches:
      - NewApi
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-22.04]
        include:
          - os: macos-latest
            platform: mac
            artifact: '*.dmg'
          - os: windows-latest
            platform: win
            artifact: '*Setup*.exe'
          - os: ubuntu-22.04
            platform: linux
            artifact: '*.AppImage'

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: '16.20.2'
          cache: 'yarn'

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y \
            rpm \
            libarchive-tools \
            libopenjp2-tools \
            snapd

      - name: Install Snapcraft (Ubuntu)
        if: runner.os == 'Linux'
        uses: samuelmeuli/action-snapcraft@v2
        with:
          skip_install: false

      # ==================== å®‰è£…ä¾èµ– ====================
      - name: Install project dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_ENV: development

      # ==================== å®‰è£… netease-api ä¾èµ– ====================
      - name: Install netease-api dependencies
        run: |
          cd netease-api
          yarn install --production --frozen-lockfile
          cd ..
        shell: bash

      # ==================== è·å– UNM ç‰ˆæœ¬ ====================
      - id: get_unm_version
        name: Get UNM version
        run: |
          unm_version=$(node -e "console.log(require('./node_modules/@unblockneteasemusic/rust-napi/package.json').version)")
          echo "unmver=${unm_version}" >> $GITHUB_OUTPUT
        shell: bash

      # ==================== Windows å¹³å°ç‰¹å®šä¾èµ– ====================
      - name: Install UNM dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          ${{ env.YARN_INSTALL_NOPT }} \
            @unblockneteasemusic/rust-napi-win32-x64-msvc@${{steps.get_unm_version.outputs.unmver}}
        shell: bash

      # ==================== macOS å¹³å°ç‰¹å®šä¾èµ– ====================
      - name: Install UNM dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          ${{ env.YARN_INSTALL_NOPT }} \
            @unblockneteasemusic/rust-napi-darwin-x64@${{steps.get_unm_version.outputs.unmver}} \
            @unblockneteasemusic/rust-napi-darwin-arm64@${{steps.get_unm_version.outputs.unmver}} \
            dmg-license
        shell: bash

      # ==================== Linux å¹³å°ç‰¹å®šä¾èµ– ====================
      - name: Install UNM dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          ${{ env.YARN_INSTALL_NOPT }} \
            @unblockneteasemusic/rust-napi-linux-x64-gnu@${{steps.get_unm_version.outputs.unmver}} \
            @unblockneteasemusic/rust-napi-linux-arm64-gnu@${{steps.get_unm_version.outputs.unmver}} \
            @unblockneteasemusic/rust-napi-linux-arm-gnueabihf@${{steps.get_unm_version.outputs.unmver}}
        shell: bash

      # ==================== æ„å»ºåº”ç”¨ ====================
      - name: Build Electron app
        uses: samuelmeuli/action-electron-builder@v1.6.0
        env:
          # API é…ç½®
          VUE_APP_NETEASE_API_URL: /api
          VUE_APP_ELECTRON_API_URL: /api
          VUE_APP_ELECTRON_API_URL_DEV: http://127.0.0.1:10754
          # Last.fm API å¯†é’¥
          VUE_APP_LASTFM_API_KEY: 09c55292403d961aa517ff7f5e8a3d9c
          VUE_APP_LASTFM_API_SHARED_SECRET: 307c9fda32b3904e53654baff215cb67
        with:
          github_token: ${{ secrets.github_token }}
          # å¦‚æœæ˜¯ tag æ¨é€åˆ™å‘å¸ƒ release
          release: ${{ startsWith(github.ref, 'refs/tags/v') }}
          use_vue_cli: true

      # ==================== ä¸Šä¼ æ„å»ºäº§ç‰© ====================
      - name: Upload artifacts (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: YesPlayMusic-NewAPI-macOS-${{ github.sha }}
          path: |
            dist_electron/*.dmg
            dist_electron/*.dmg.blockmap
            dist_electron/latest-mac.yml
          if-no-files-found: error
          retention-days: 30

      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: YesPlayMusic-NewAPI-Windows-${{ github.sha }}
          path: |
            dist_electron/*Setup*.exe
            dist_electron/*Setup*.exe.blockmap
            dist_electron/latest.yml
          if-no-files-found: error
          retention-days: 30

      - name: Upload artifacts (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: YesPlayMusic-NewAPI-Linux-${{ github.sha }}
          path: |
            dist_electron/*.AppImage
            dist_electron/*.deb
            dist_electron/*.rpm
            dist_electron/*.tar.gz
            dist_electron/latest-linux.yml
          if-no-files-found: error
          retention-days: 30

  # ==================== åˆ›å»º Release ====================
  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: contains(github.ref, 'beta') || contains(github.ref, 'alpha')
          name: YesPlayMusic NewAPI ${{ github.ref_name }}
          body: |
            ## ğŸ‰ YesPlayMusic with New API
            
            ### ğŸ“¦ What's New
            - ä½¿ç”¨ @neteaseapireborn/api v4.29.7
            - æ”¯æŒ Node.js 16+
            - ä¼˜åŒ–äº† API è°ƒç”¨æ€§èƒ½
            - ä¿®å¤äº†è‹¥å¹²å·²çŸ¥é—®é¢˜
            
            ### ğŸ“¥ Download
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…ï¼š
            
            - **macOS**: 
              - Intel (x64): `YesPlayMusic-mac-*-x64.dmg`
              - Apple Silicon (arm64): `YesPlayMusic-mac-*-arm64.dmg`
              - Universal: `YesPlayMusic-mac-*-universal.dmg`
            
            - **Windows**: 
              - `YesPlayMusic-*-Setup-*.exe` (å®‰è£…ç‰ˆ)
              - `YesPlayMusic-*-portable.exe` (ä¾¿æºç‰ˆ)
            
            - **Linux**:
              - `YesPlayMusic-*.AppImage` (é€šç”¨)
              - `YesPlayMusic-*.deb` (Debian/Ubuntu)
              - `YesPlayMusic-*.rpm` (RedHat/Fedora)
              - `YesPlayMusic-*.tar.gz` (æºç åŒ…)
            
            ### ğŸ› Known Issues
            è¯·åœ¨ Issues é¡µé¢æŠ¥å‘Šæ‚¨é‡åˆ°çš„é—®é¢˜
            
            ### ğŸ“ Changelog
            è¯¦ç»†æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ commit è®°å½•
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== æ„å»ºæˆåŠŸé€šçŸ¥ ====================
  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build Status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… Build succeeded on all platforms!"
          else
            echo "âŒ Build failed!"
            exit 1
          fi
